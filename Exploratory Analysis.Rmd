---
title: "Island Planting Project - Exploratory Analysis"
output: word_document
---
  
  
# Background
Restoration must balance limited resources towards the most effective outcomes, given specified targets. Removing and suppressing invasive vegetation can give introduced native species the opportunity to establish. There are a variety of techniques used to help native species establish by suppressing weeds. Initially, laying mulch can reduce the cover of weedy species. However, it is less clear how much this initial benefit affects long-term success and native cover, or whether un-mulched areas will “catch up” with mulched plots once species establish. Annual mowing is another technique that can be used to reduce invasive species cover, and therefore potentially benefit native species.  
  
In addition to the suppression of weedy invasive species, native species must be reintroduced to the system. The nucleation model of succession may provide insight into a technique to successfully restore system with reduced resource inputs. By planting target species in clumps (“islands”) as opposed to throughout the plot, we may effectively restore areas with reduced inputs. After multiple years of growth and spread, the native islands may expand, resulting over the long term in similar levels of native species cover with a lower up-front resource investment.  

### Questions
**This study addresses the following questions:**  
1. Will island-planted plots have the same native cover as full-planted plots after several years?, and Will island planted plots spread outside of their planted areas?  
2. Does annual mowing benefit native species cover for either grasses or forbs?  
3. Does mulching affect native cover in the long-term/how long does the mulching effect last?  
4. Of the species planted, which were most successful in the long term? 
  
  
```{r Setup, include=FALSE}
# packages
library(grid)
library(gridExtra)
library(tidyverse)
library(boot)
library(nlme)
library(MASS)

# legend extractor function
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

# figure colors
colors3 <- c("#6a3d9a", "#6a3d9a", "#33a02c", "#33a02c", "#f46d43", "#f46d43")

```

```{r Import, include=FALSE}
# data
guild_12_18 <- read.csv("Guild_2012_2018.csv")
species_14_18 <- read.csv("Species_2014_2018.csv")

```

# Data Structure  

Before I begin the analysis, I need to take a look at the data's structure -- the data is certainly zero-inflated, but is it over-dispersed? A look at the data structure will help me select the best model for the data. I'll base this on the guide in Appendix A of **Mixed effects models and extensions in ecology with R: appendix walkthrough**.

The replicated sampling unit differs for different questions. For the first question (how do treatments vary?), the replicate is a single plot, so I will average the individual samples to the plot level. Additionally, I'll need to separate forbs and grasses in the analysis, since they were planted in separate areas. I'll use "F" to denote forbs, and "G" for grasses.

## Selecting Revelant Data
We have only 2 remaining datacleanup steps before we can examine the data structure:
1. we need to look at forbs only in the forb planted plots, and only grass in the grass planted plots. 
2. we need to average the cover of each guild over the multiple samples from a single plot. 

```{r Averaging to plot level, cache=TRUE, echo=FALSE, message=FALSE}
avg_guilds <- guild_12_18 %>%
  group_by(Year, Plot, Planted.guild, Category, Mowing.treatment) %>%
  summarise(nat.forb = mean(nat.forb),
            nat.grass = mean(nat.grass))
  
avg_F <- avg_guilds %>%
  filter(Planted.guild == "Forb") %>%
  ungroup() %>%
  dplyr::select(Year, Plot, nat.forb, Category, Mowing.treatment) %>%
  rename(Cover = nat.forb) %>%
  mutate(guild = "forb")
summary(avg_F)
str(avg_F)

avg_G <- avg_guilds %>%
  filter(Planted.guild == "Grass") %>%
  ungroup() %>%
  dplyr::select(Year, Plot, nat.grass, Category, Mowing.treatment) %>%
  rename(Cover = nat.grass) %>%
  mutate(guild = "grass")

avg_guilds <- full_join(avg_F, avg_G) %>%
  mutate(Cover = (Cover/100),
         Planting = ifelse(Category == "Full Mulched", "Full", 
                           ifelse(Category == "Full Not Mulched", "Full",
                                   ifelse(Category == "Island Mulched", "Island", "WRONG"))),
         Mulch = ifelse(Category == "Full Mulched", "Mulch", 
                           ifelse(Category == "Full Not Mulched", "No Mulch",
                                   ifelse(Category == "Island Mulched", "Mulch", "WRONG"))))
str(avg_guilds)

```

Clearly, some of the data are missing (there should be 15 plots, 5 per category x 7 years = 35 plots per category). All of the missing plots are due to the 2014 dataset missing values. We are missing 1 FNM plot (#9), 2 FNM plots (#14, 25), and 2 IM plots (#15, 19), all from the 2014 dataset.  
There's unfortunately nothing I can do about this -- *Perhaps there is still hard copy data somewhere on file? Alternatively, we may not care, if most analyses are interested in comparisons in 2018.*  

## Histogram, dispersion, outliers
Let's take a look at the histogram of the data, since we're fairly certain it's nowhere near normal:

```{r Histogram, echo=FALSE, dependson="Averaging to plot level"}
ggplot(avg_guilds, aes(Cover, fill=Category)) +
  geom_histogram()

hist(avg_guilds$Cover)
```

Our data isn't normal. Here's a table of the variance and dispersion index of our data:

```{r Dispersion, cache=TRUE, dependson="Averaging to plot level"}
disp <- avg_guilds %>%
  summarise(mean = mean(Cover),
            var = var(Cover)) %>%
  mutate(d = var/mean)

disp

```

Very clearly, we need to use a model that can handle the quirks of our data: proportions, skewed, and an unbalanced comparison. A zero-inflated negative binomial is probably not the best choice. A normal ANOVA is not robust against the overdispersion in our data. We'll settle for a GLM.


### A.2.1: Outliers
**Mixed effects models and extensions in ecology with R** suggests using dot plots to check for outliers:  
```{r Outlier Check, echo=FALSE, dependson="Averaging to plot level", cache=TRUE}
dotchart(avg_guilds$Cover, 
         groups = factor(avg_guilds$Category), 
         main = "Cover by Category")
```
There is an outlier or two for exotic species cover, but because we'll be analyzing native species cover, we can leave those in.


### Boxplots
```{r Boxplots, echo=FALSE}
boxplot(Cover ~ factor(Category), varwidth = TRUE,
        xlab = "Category", main = "Cover by Category",
        ylab = "Cover", data=avg_guilds)

boxplot(Cover ~ factor(guild), varwidth = TRUE,
        xlab = "Guild", main = "Cover by Category",
        ylab = "Cover", data=avg_guilds)

```

From the first boxplot of categories, it is fairly clear that the heterogeneity rules are being broken.

# Results
## Questions 1, 2, & 3: 
**1. Do island-planted plots have the same native cover as full-planted plots after 6 years?  
2. Does mulching affect native cover in the long-term/how long does the mulching effect last?  
3. Does annual mowing benefit native species cover for either grasses or forbs?**

The cover of native species was fairly similar across all three treatments over time.  
  
```{r Graphing guild-level data, echo=FALSE, cache=TRUE}

Forb_all <- avg_F %>%
  group_by(Category, Year) %>%
  summarise(mean.cov = mean(Cover),
            std.err = sd(Cover)/sqrt(sum(!is.na(Cover))))
Forb_all$Year <- as.numeric(Forb_all$Year)


AllYrForb <- ggplot(Forb_all, aes (x = Year,  y = mean.cov, color = Category, shape = Category)) +
  geom_line () +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean.cov - std.err, 
                    ymax = mean.cov + std.err),
               width=0.2) +
  scale_color_manual(values = colors3,
                    name = "Plot Treatment") +
  scale_shape_manual(values = c(1, 2, 4, 5, 6),
                     name = "Plot Treatment") +
  labs(title = "",
       y = "Relative Native \n Forb Cover (%)",
       x = "Year") +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.y = element_text(colour="black", size = 10),
        axis.title.y = element_text(colour="black", size = 12),
        axis.ticks.y = element_line(colour = "black"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_line(colour = "black"),
        legend.position ="bottom",
        plot.title = element_text(hjust = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(color = "black", size = 12)) +
  coord_cartesian(ylim = c(0, 50)) +
  scale_y_continuous(breaks = seq(0, 50, 5), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(2012, 2018, 1))

# ---- Native Grasses ----
Grass_all <- avg_G %>%
  group_by(Category, Year) %>%
  summarise(mean.cov = mean(Cover),
            std.err = sd(Cover)/sqrt(sum(!is.na(Cover))))
Grass_all$Year <- as.numeric(Grass_all$Year)

AllYrGrass <- ggplot(Grass_all, aes (x = Year,  y = mean.cov, color = Category, shape = Category)) +
  geom_line () +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean.cov - std.err, 
                    ymax = mean.cov + std.err),
                width=0.2) +
  scale_color_manual(values = colors3,
                     name = "Plot Treatment") +
  scale_shape_manual(values = c(1, 2, 4, 5, 6),
                     name = "Plot Treatment") +
  labs(title = "",
       y = "Relative Native \n Grass Cover (%)",
       x = "Year") +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.y = element_text(colour="black", size = 10),
        axis.title.y = element_text(colour="black", size = 12),
        axis.ticks.y = element_line(colour = "black"),
        axis.text.x = element_text(colour="black", size = 10),
        axis.title.x = element_text(colour="black", size = 12),
        axis.ticks.x = element_line(colour = "black"),
        legend.position ="bottom",
        plot.title = element_text(hjust = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(color = "black", size = 12)) +
  coord_cartesian(ylim = c(0, 50)) +
  scale_y_continuous(breaks = seq(0, 50, 5), expand = c(0,0)) +
  scale_x_continuous(breaks = seq(2012, 2018, 1))


AllYrLeg <- g_legend(AllYrGrass)

grid.arrange(arrangeGrob(AllYrForb + theme(legend.position="none"),
                         AllYrGrass + theme(legend.position="none"),
                         nrow = 2),
             AllYrLeg, nrow = 2, heights = c(12, 1))


```

To test whether there is a signficiant difference in treatments after 7 years, we will use a GLM on only the 2018 data.  

The zero-inflated model is not the correct model to use because it is based on count data - which our data are not.  
I am running a generalized linear model with a quasibinomial structure, given that our data are proportion data and slightly overdispersed. 

We also suspect that our data do not have homogeneous variance, so we will allow flexible variance.

```{r GLM 2018, echo=FALSE, dependson="Averaging to plot level"}
F2018 <- avg_guilds %>%
  filter(guild == "forb",
         Year == "2018")
F2018$Category <- as.factor(F2018$Category)
F2018$Mulch <- as.factor(F2018$Mulch)
F2018$Mowing.treatment <- as.factor(F2018$Mowing.treatment)
F2018$Planting <- as.factor(F2018$Planting)

F18_GLM_quasi <- glm(Cover ~ Planting * Mulch * Mowing.treatment, family = quasibinomial, 
                   data = F2018)
summary(F18_GLM_quasi)
anova(F18_GLM_quasi, test = "LRT")


G2018 <- avg_guilds %>%
  filter(guild == "grass",
         Year == "2018")
G2018$Category <- as.factor(G2018$Category)
G2018$Mulch <- as.factor(G2018$Mulch)
G2018$Mowing.treatment <- as.factor(G2018$Mowing.treatment)
G2018$Planting <- as.factor(G2018$Planting)

G18_GLM_quasi <- glm(Cover ~ Planting * Mulch * Mowing.treatment, family = quasibinomial, 
                   data = G2018)
summary(G18_GLM_quasi)
anova(G18_GLM_quasi, test = "LRT")
```


### Checking the residuals
```{r Residual check, dependson="GLM 2018", echo=FALSE}

op <- par(mfrow = c(2, 3), mar = c(5, 4, 1, 2))
plot(F18_GLM_quasi, add.smooth = FALSE, which = 1)
res_F18 <-resid(F18_GLM_quasi)
hist(res_F18, xlab = "Residuals", main = "")
plot(x = F2018$Cover, y = res_F18, 
     xlab = "Cover", ylab = "Residuals")
plot(F2018$Planting, res_F18, 
     xlab = "Planting", ylab = "Residuals")
plot(F2018$Mulch, res_F18, 
     xlab = "Mulch", ylab = "Residuals")
plot(F2018$Mowing.treatment, res_F18, 
     xlab = "Mowing treatment", ylab = "Residuals")
par(op)
glm.diag.plots(F18_GLM_quasi)

op <- par(mfrow = c(2, 3), mar = c(5, 4, 1, 2))
plot(G18_GLM_quasi, add.smooth = FALSE, which = 1)
res_G18 <-resid(G18_GLM_quasi)
hist(res_G18, xlab = "Residuals", main = "")
plot(x = G2018$Cover, y = res_G18, 
     xlab = "Cover", ylab = "Residuals")
plot(G2018$Planting, res_G18, 
     xlab = "Planting", ylab = "Residuals")
plot(G2018$Mulch, res_G18, 
     xlab = "Mulch", ylab = "Residuals")
plot(G2018$Mowing.treatment, res_G18, 
     xlab = "Mowing treatment", ylab = "Residuals")
par(op)
glm.diag.plots(G18_GLM_quasi)


```


### Curiosity about 2017
I'm curious what happens for the 2017 data, since it seems much clearer that there's an effect of mulching/planting style.

```{r 2017 Forb data, echo = FALSE}
F2017 <- avg_guilds %>%
  filter(guild == "forb",
         Year == "2017")
F2017$Mulch <- as.factor(F2017$Mulch)
F2017$Mowing.treatment <- as.factor(F2017$Mowing.treatment)
F2017$Planting <- as.factor(F2017$Planting)

F17_GLM_quasi <- glm(Cover ~ Planting * Mowing.treatment * Mulch, family = quasibinomial, 
                   data = F2017)
summary(F17_GLM_quasi)
anova(F17_GLM_quasi, test = "Chisq")

op <- par(mfrow = c(2, 3), mar = c(5, 4, 1, 2))
plot(F17_GLM_quasi, add.smooth = FALSE, which = 1)
res_F17 <-resid(F17_GLM_quasi)
hist(res_F17, xlab = "Residuals", main = "")
plot(x = F2017$Cover, y = res_F17, 
     xlab = "Cover", ylab = "Residuals")
plot(F2017$Planting, res_F17, 
     xlab = "Planting", ylab = "Residuals")
plot(F2017$Mulch, res_F17, 
     xlab = "Mulch", ylab = "Residuals")
plot(F2017$Mowing.treatment, res_F17, 
     xlab = "Mowing treatment", ylab = "Residuals")
par(op)


```


   
  
## Question 4: Did the cover in island planted plots spread outside of the planted areas?

First, we need to create a dataframe of the island planted sections vs. the full sections for only 2018.

```{r In/Edge/Out/Full dataframe, echo=FALSE}
avg_spread<- guild_12_18 %>%
  group_by(Year, Plot, QuadLocation, Planted.guild) %>%
  summarise(nat.forb = mean(nat.forb),
            nat.grass = mean(nat.grass))

f_spread <- avg_spread %>%
  filter(Planted.guild == "Forb") %>%
  ungroup() %>%
  dplyr::select(Year, Plot, nat.forb, QuadLocation) %>%
  rename(Cover = nat.forb) %>%
  mutate(guild = "forb") %>%
  filter(QuadLocation == "Edge" | 
           QuadLocation == "Full" |
           QuadLocation == "Island" |
           QuadLocation == "Out")
summary(f_spread)
str(f_spread)

g_spread <- avg_spread %>%
  filter(Planted.guild == "Grass") %>%
  ungroup() %>%
  dplyr::select(Year, Plot, nat.grass, QuadLocation) %>%
  rename(Cover = nat.grass) %>%
  mutate(guild = "grass") %>%
  filter(QuadLocation == "Edge" | 
           QuadLocation == "Full" |
           QuadLocation == "Island" |
           QuadLocation == "Out")

avg_spread <- full_join(f_spread, g_spread) %>%
  mutate(Cover = (Cover/100))

```

```{r Spread GLM, echo=FALSE}
# Forbs
F_spread18 <- avg_spread %>%
  filter(guild == "forb",
         Year == "2018")
F_spread18$QuadLocation <- as.factor(F_spread18$QuadLocation)

F18_spreadGLM_quasi <- glm(Cover ~ QuadLocation, family = quasibinomial, 
                   data = F_spread18)
summary(F18_spreadGLM_quasi)
anova(F18_spreadGLM_quasi, test = "Chisq")

#Grasses
G_spread18 <- avg_spread %>%
  filter(guild == "grass",
         Year == "2018")
G_spread18$QuadLocation <- as.factor(G_spread18$QuadLocation)

G18_spreadGLM_quasi <- glm(Cover ~ QuadLocation, family = quasibinomial, 
                   data = G_spread18)
summary(G18_spreadGLM_quasi)
anova(G18_spreadGLM_quasi, test = "Chisq")

```

```{r spread residuals, echo=FALSE}
op <- par(mfrow = c(2, 2), mar = c(5, 4, 1, 2))
plot(F18_spreadGLM_quasi, add.smooth = FALSE, which = 1)
res_spreadF18 <-resid(F18_spreadGLM_quasi)
hist(res_spreadF18, xlab = "Residuals", main = "")
plot(x = F_spread18$Cover, y = res_spreadF18, 
     xlab = "Cover", ylab = "Residuals")
plot(F_spread18$QuadLocation, res_spreadF18, 
     xlab = "QuadLocation", ylab = "Residuals")
par(op)


op <- par(mfrow = c(2, 2), mar = c(5, 4, 1, 2))
plot(G18_spreadGLM_quasi, add.smooth = FALSE, which = 1)
res_spreadG18 <-resid(G18_spreadGLM_quasi)
hist(res_spreadG18, xlab = "Residuals", main = "")
plot(x = G_spread18$Cover, y = res_spreadG18, 
     xlab = "Cover", ylab = "Residuals")
plot(G_spread18$QuadLocation, res_spreadG18, 
     xlab = "QuadLocation", ylab = "Residuals")
par(op)

```


# Means and Std. Err reports
These are the calculations for the means and std. errors, to be reported in the final paper. 

```{r Means+SE Calcs & plots, echo=FALSE}

mean_se <- avg_guilds %>%
  group_by(guild, Year, Planting, Mulch, Mowing.treatment) %>%
  summarise(meancov = mean(Cover),
            se = (var(Cover)/(length(Cover))))

df_plot_F <- avg_guilds %>%
  group_by(guild, Year, Planting, Mulch, Mowing.treatment) %>%
  summarise(meancov = mean(Cover),
            se = (var(Cover)/(length(Cover)))) %>%
  filter(guild == "forb",
         Year != "2012") %>%
  unite(Planting, Mulch, Mowing.treatment, col = "Treatment", sep =" ")
df_plot_F$Treatment <-factor (df_plot_F$Treatment, levels = c("Island Mulch Mowed", "Island Mulch Unmowed",
                                                              "Full No Mulch Mowed", "Full No Mulch Unmowed", 
                                                              "Full Mulch Mowed", "Full Mulch Unmowed"))

F_meansplot <- ggplot(df_plot_F, aes (x = Year,  y = meancov*100, color = Treatment, shape = Treatment)) +
  geom_line () +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = meancov*100 - se*100, 
                    ymax = meancov*100 + se*100),
                width=0.2) +
  scale_color_manual(values = colors3,
                    name = "Plot Treatment") +
  scale_shape_manual(values = c(2, 17, 0, 15, 1, 16),
                     name = "Plot Treatment") +
  labs(title = "",
       y = " Native Forb Cover (%)",
       x = "Year") +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.y = element_text(colour="black", size = 10),
        axis.title.y = element_text(colour="black", size = 12),
        axis.ticks.y = element_line(colour = "black"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_line(colour = "black"),
        legend.position ="bottom",
        plot.title = element_text(hjust = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(color = "black", size = 12)) +
  coord_cartesian(ylim = c(0, 50)) 


df_plot_G <- avg_guilds %>%
  group_by(guild, Year, Planting, Mulch, Mowing.treatment) %>%
  summarise(meancov = mean(Cover),
            se = (var(Cover)/(length(Cover)))) %>%
  filter(guild == "grass",
         Year != "2012") %>%
  unite(Planting, Mulch, Mowing.treatment, col = "Treatment", sep =" ")
df_plot_G$Treatment <-factor (df_plot_G$Treatment, levels = c("Island Mulch Mowed", "Island Mulch Unmowed",
                                                              "Full No Mulch Mowed", "Full No Mulch Unmowed", 
                                                              "Full Mulch Mowed", "Full Mulch Unmowed"))


G_meansplot <- ggplot(df_plot_G, aes (x = Year,  y = meancov*100, color = Treatment, shape = Treatment)) +
  geom_line () +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = meancov*100 - se*100, 
                    ymax = meancov*100 + se*100),
                width=0.2) +
  scale_color_manual(values = colors3,
                    name = "Plot Treatment") +
  scale_shape_manual(values = c(2, 17, 0, 15, 1, 16),
                     name = "Plot Treatment") +
  labs(title = "",
       y = " Native Grass Cover (%)",
       x = "Year") +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.y = element_text(colour="black", size = 10),
        axis.title.y = element_text(colour="black", size = 12),
        axis.ticks.y = element_line(colour = "black"),
        axis.text.x = element_text(colour="black", size = 10),
        axis.title.x = element_text(colour="black", size = 12),
        axis.ticks.x = element_line(colour = "black"),
        legend.position ="bottom",
        plot.title = element_text(hjust = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(color = "black", size = 12)) +
  coord_cartesian(ylim = c(0, 50))


Means_Leg <- g_legend(G_meansplot)

grid.arrange(arrangeGrob(F_meansplot + theme(legend.position="none"),
                         G_meansplot + theme(legend.position="none"),
                         nrow = 2),
             Means_Leg, nrow = 2, heights = c(12, 1))

```


